- **WMI 서비스 재시작은 다른 서비스에 영향을 줄 수 있습니다**
- 서버 환경에서는 주의가 필요합니다

## WMI 재시작의 영향

### 영향받는 서비스들
```powershell
# WMI에 의존하는 서비스 확인
Get-Service | Where-Object {$_.DependentServices -contains 'winmgmt'}

# 일반적으로 영향받는 서비스:
# - IP Helper (iphlpsvc)
# - Security Center (wscsvc)
# - Windows Firewall
# - SMS Agent Host (일부 모니터링 도구)
# - SCCM Client
# - 일부 백업 소프트웨어
# - 모니터링 에이전트들
```

### 더 안전한 방법들 (서버 환경 권장)

#### 방법 A: 레지스트리 삭제 후 대기만 하기 (가장 안전)
```powershell
# 1. 레지스트리 삭제
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\filebeat" /f

# 2. services.msc 창 닫기
Stop-Process -Name mmc -Force -ErrorAction SilentlyContinue

# 3. 30초-1분 대기 (자동 새로고침 대기)
Write-Host "Waiting for service cache refresh (30 seconds)..." -ForegroundColor Yellow
Start-Sleep -Seconds 30

# 4. 확인
sc.exe query filebeat
# "지정된 서비스가 설치된 서비스가 아닙니다" 나오면 성공

# 5. 재설치
cd D:\filebeat
.\install-service-filebeat.ps1
```

#### 방법 B: PowerShell 서비스 캐시만 새로고침
```powershell
# 1. 레지스트리 삭제
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\filebeat" /f

# 2. PowerShell 서비스 캐시 새로고침 (영향 최소)
[System.ServiceProcess.ServiceController]::GetServices() | Out-Null
Get-Service | Out-Null

# 3. 10초 대기
Start-Sleep -Seconds 10

# 4. 재설치
cd D:\filebeat
.\install-service-filebeat.ps1
```

#### 방법 C: 다른 이름으로 우회 설치 (즉시 해결)
```powershell
# install-service-filebeat-custom.ps1로 저장

# 기존 코드에서 서비스명 부분만 수정
$ServiceName = "filebeat_v2"  # 또는 filebeat1, filebeat_new 등

# 서비스 생성 부분
New-Service -name $ServiceName `
  -displayName "Filebeat v2" `
  -binaryPathName $FullCmd

Write-Host "Service installed as: $ServiceName" -ForegroundColor Green
```

#### 방법 D: SC 명령으로 강제 플러시
```powershell
# 1. 레지스트리 삭제
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\filebeat" /f

# 2. SC 명령으로 서비스 목록 강제 새로고침 (영향 최소)
sc.exe control scmanager 129  # 서비스 목록 새로고침 신호

# 3. 10초 대기
Start-Sleep -Seconds 10

# 4. 재설치
cd D:\filebeat
.\install-service-filebeat.ps1
```

### 서버 환경 최종 권장안
```powershell
# safe-reinstall-filebeat.ps1

Write-Host "Safely reinstalling Filebeat service..." -ForegroundColor Cyan

# 1. 레지스트리 정리
Write-Host "Step 1: Cleaning registry..." -ForegroundColor Yellow
reg delete "HKLM\SYSTEM\CurrentControlSet\Services\filebeat" /f 2>$null

# 2. MMC 종료 (GUI만 영향)
Stop-Process -Name mmc -Force -ErrorAction SilentlyContinue

# 3. 서비스 캐시 새로고침 시도
Write-Host "Step 2: Refreshing service cache..." -ForegroundColor Yellow
[System.ServiceProcess.ServiceController]::GetServices() | Out-Null

# 4. 대기
Write-Host "Step 3: Waiting 30 seconds for cache refresh..." -ForegroundColor Yellow
for ($i = 30; $i -gt 0; $i--) {
    Write-Host -NoNewline "`r$i seconds remaining... "
    Start-Sleep -Seconds 1
}
Write-Host ""

# 5. 설치 시도
Write-Host "Step 4: Installing service..." -ForegroundColor Yellow
cd D:\filebeat

try {
    .\install-service-filebeat.ps1
    Write-Host "Success! Service installed." -ForegroundColor Green
} catch {
    Write-Host "Failed. Using alternative name..." -ForegroundColor Yellow
    # 다른 이름으로 설치하는 로직
}
```

**요약:**
- WMI 재시작은 모니터링 도구, 백업 SW 등에 영향 가능
- 서버 환경에서는 레지스트리 삭제 후 30초-1분 대기가 가장 안전
- 급하면 다른 서비스명(filebeat_v2)으로 설치하는 것이 무영향
